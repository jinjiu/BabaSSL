---
name: Windows GitHub CI

on: [pull_request, push]

jobs:
  minimal:
    strategy:
      matrix:
        os:
        - windows-2019
    runs-on: ${{matrix.os}}
    steps:
    - uses: actions/checkout@v2
    - uses: ilammy/msvc-dev-cmd@v1
    - uses: shogo82148/actions-setup-perl@v1
    - name: prepare the build directory
      run: mkdir _build
    - name: Ngrok debugger
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
      run: |
        echo 11111
        choco install --yes --no-progress ngrok
        echo 22222
        echo $env:NGROK_TOKEN
        ngrok.exe authtoken $env:NGROK_TOKEN
        echo 33333
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0
        echo 44444
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        echo 55555
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        echo 66666
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "$env:NGROK_TOKEN" -Force)
        echo 77777
        type C:\Users\runneradmin/.ngrok2/ngrok.yml
        ngrok.exe tcp 3389
        echo 88888
    - name: config
      working-directory: _build
      run: |
        perl ..\Configure no-makedepend no-deprecated no-asm -DOPENSSL_SMALL_FOOTPRINT VC-WIN64A
        perl configdata.pm --dump
    - name: build
      working-directory: _build
      run: nmake # verbose, so no /S here
    - name: test
      working-directory: _build
      run: nmake test VERBOSE_FAILURE=yes TESTS=-test_fuzz*
